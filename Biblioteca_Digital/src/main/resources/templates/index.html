<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Biblioteca Digital - Inicio</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		:root {
			--primary-color: #667eea;
			--secondary-color: #764ba2;
		}

		body {
			background-color: #f8f9fa;
		}

		.navbar {
			background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.hero-section {
			background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
			color: white;
			padding: 60px 0;
			margin-bottom: 40px;
		}

		.search-box {
			background: white;
			border-radius: 50px;
			padding: 5px;
			box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
		}

		.search-box input {
			border: none;
			padding: 12px 25px;
		}

		.search-box input:focus {
			outline: none;
			box-shadow: none;
		}

		.search-box button {
			background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
			border: none;
			color: white;
			border-radius: 50px;
			padding: 10px 30px;
		}

		.libro-card {
			border: none;
			border-radius: 15px;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
			transition: all 0.3s ease;
			height: 100%;
		}

		.libro-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
		}

		.libro-icon {
			font-size: 4rem;
			color: var(--primary-color);
			margin-bottom: 15px;
		}

		.badge-disponible {
			background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
		}

		.badge-agotado {
			background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
		}

		.btn-reservar {
			background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
			border: none;
			color: white;
			transition: all 0.3s ease;
		}

		.btn-reservar:hover {
			transform: scale(1.05);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
		}

		.empty-state {
			text-align: center;
			padding: 60px 20px;
		}

		.empty-state i {
			font-size: 5rem;
			color: #dee2e6;
			margin-bottom: 20px;
		}
	</style>
</head>

<body>
	<!-- Navbar -->
	<nav class="navbar navbar-expand-lg navbar-dark">
		<div class="container">
			<a class="navbar-brand" href="/">
				<i class="fas fa-book-reader me-2"></i>Biblioteca Digital
			</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav ms-auto">
					<li class="nav-item">
						<a class="nav-link active" href="/">
							<i class="fas fa-home me-1"></i>Inicio
						</a>
					</li>

					<li class="nav-item" sec:authorize="isAuthenticated()">
						<a class="nav-link" href="/mis-reservas">
							<i class="fas fa-bookmark me-1"></i>Mis Reservas
						</a>
					</li>
					<li class="nav-item" sec:authorize="isAuthenticated()">
						<a class="nav-link" href="/mis-evaluaciones">
							<i class="fas fa-star me-1"></i>Mis Evaluaciones
						</a>
					</li>

					<li class="nav-item" sec:authorize="hasRole('ADMIN')">
						<a class="nav-link" href="/admin/libros">
							<i class="fas fa-cog me-1"></i>Administrar
						</a>
					</li>

					<li class="nav-item" sec:authorize="!isAuthenticated()">
						<a class="nav-link" href="/login">
							<i class="fas fa-sign-in-alt me-1"></i>Iniciar Sesión
						</a>
					</li>

					<li class="nav-item" sec:authorize="!isAuthenticated()">
						<a class="nav-link" href="/registro">
							<i class="fas fa-user-plus me-1"></i>Registrarse
						</a>
					</li>

					<li class="nav-item dropdown" sec:authorize="isAuthenticated()">
						<a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
							data-bs-toggle="dropdown">
							<i class="fas fa-user-circle me-1"></i>
							<span sec:authentication="principal.nombreCompleto">Usuario</span>
						</a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li>
								<a class="dropdown-item" href="#">
									<i class="fas fa-envelope me-2"></i>
									<span sec:authentication="principal.correo"></span>
								</a>
							</li>
							<li>
								<hr class="dropdown-divider">
							</li>
							<li>
								<form th:action="@{/logout}" method="post" class="d-inline">
									<button type="submit" class="dropdown-item text-danger">
										<i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
									</button>
								</form>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="hero-section">
		<div class="container text-center">
			<h1 class="display-4 fw-bold mb-3">
				<i class="fas fa-book-open me-3"></i>Biblioteca Digital
			</h1>
			<p class="lead mb-4">Eres un gran lector</p>

			
			</div>
		</div>
	</div>

	<!-- Libros Section -->
	<div class="container mb-5">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h2><i class="fas fa-books me-2"></i>Catálogo de Libros</h2>
			<div sec:authorize="hasRole('ADMIN')">
				<a href="/admin/libros/nuevo" class="btn btn-reservar">
					<i class="fas fa-plus me-2"></i>Agregar Libro
				</a>
			</div>
		</div>

		<!-- Lista de libros -->
		<div class="row g-4" th:if="${libros != null and !libros.empty}">
			<div class="col-md-6 col-lg-4" th:each="libro : ${libros}">
				<div class="card libro-card">
					<div class="card-body text-center">
						<i class="fas fa-book libro-icon"></i>
						<h5 class="card-title fw-bold" th:text="${libro.titulo}">Título del Libro</h5>
						<p class="text-muted mb-2">
							<i class="fas fa-user me-1"></i>
							<span th:text="${libro.autor}">Autor</span>
						</p>
						<p class="text-muted small mb-2">
							<i class="fas fa-barcode me-1"></i>
							<span th:text="${libro.isbn}">ISBN</span>
						</p>
						<p class="text-muted small mb-3">
							<i class="fas fa-calendar me-1"></i>
							<span th:text="${libro.anioPublicacion}">Año</span>
						</p>

						<div class="mb-3">
							<span class="badge badge-disponible" th:if="${libro.cantidadDisponible > 0}"
								th:classappend="${libro.cantidadDisponible > 0} ? 'badge-disponible' : 'badge-agotado'">
								<i class="fas fa-check-circle me-1"></i>
								<span th:text="${libro.cantidadDisponible} + ' disponibles'">5 disponibles</span>
							</span>
							<span class="badge badge-agotado" th:if="${libro.cantidadDisponible == 0}">
								<i class="fas fa-times-circle me-1"></i>
								No disponible
							</span>
						</div>

						<button class="btn btn-reservar w-100" sec:authorize="isAuthenticated()"
							th:disabled="${libro.cantidadDisponible == 0}"
							th:attr="data-libro-id=${libro.idLibro}, data-libro-titulo=${libro.titulo}"
							onclick="reservarLibro(this)">
							<i class="fas fa-bookmark me-2"></i>Reservar
						</button>

						<a href="/login" class="btn btn-outline-secondary w-100" sec:authorize="!isAuthenticated()">
							<i class="fas fa-sign-in-alt me-2"></i>Inicia sesión para reservar
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Empty state -->
		<div class="empty-state" th:if="${libros == null or libros.empty}">
			<i class="fas fa-book-open"></i>
			<h3 class="text-muted">No se encontraron libros</h3>
			<p class="text-muted">
				<span th:if="${param.q}">No hay resultados para "<span th:text="${param.q}"></span>"</span>
				<span th:unless="${param.q}">Aún no hay libros en el catálogo</span>
			</p>
			<a href="/" class="btn btn-reservar" th:if="${param.q}">
				<i class="fas fa-arrow-left me-2"></i>Ver todos los libros
			</a>
		</div>
	</div>

	<!-- Toast notification -->
	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
		<div id="toastNotification" class="toast" role="alert">
			<div class="toast-header">
				<i class="fas fa-check-circle text-success me-2"></i>
				<strong class="me-auto">Biblioteca Digital</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast"></button>
			</div>
			<div class="toast-body" id="toastMessage">
				Mensaje
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		async function reservarLibro(button) {
			const libroId = button.getAttribute('data-libro-id');
			const libroTitulo = button.getAttribute('data-libro-titulo');

			button.disabled = true;
			button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Reservando...';

			try {
				const response = await fetch('/api/reservas', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({libroId: parseInt(libroId)})
				});

				if (response.ok) {
					showToast('¡Reserva exitosa! El libro "' + libroTitulo + '" ha sido reservado.');
					setTimeout(() => {
						window.location.reload();
					}, 2000);
				} else {
					const error = await response.text();
					alert('Error: ' + error);
					button.disabled = false;
					button.innerHTML = '<i class="fas fa-bookmark me-2"></i>Reservar';
				}
			} catch (error) {
				alert('Error de conexión. Por favor, intenta nuevamente.');
				button.disabled = false;
				button.innerHTML = '<i class="fas fa-bookmark me-2"></i>Reservar';
			}
		}

		function showToast(message) {
			const toastElement = document.getElementById('toastNotification');
			const toastMessage = document.getElementById('toastMessage');
			toastMessage.textContent = message;

			const toast = new bootstrap.Toast(toastElement);
			toast.show();
		}
	</script>
</body>

</html>